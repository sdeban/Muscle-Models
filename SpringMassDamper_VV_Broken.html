<!doctype html>
<html>

<head>
</head>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  /*   Spring-Mass model looping example.  
    
      NOTE: This does not work in this javascript implementation. Why?
    
    
    Author: Stephen M. Deban, University of South Florida. */

  // Load google chart API for graphing.
  google.charts.load('current', {
    'packages': ['corechart']
  }); // Load the corechart package which has line charts and others.

  // Execute the simulation and graphing upon page load.
  window.onload = function() {
    runSim.click(); // 'runSim' is the id for the 'apply' button.  
  }

  //Simulation settings

  // TODO: VV function does not work. I have no idea why. It works perfectly in R and Lua. 

  function springMass() {

    // Get values from form in webpage. NOTE: '+' coerces the strings retrieved to numbers. Default values are stored in the form elements in the html.
    var duration = +document.getElementById("duration-input").value; // Duration in seconds.
    var steps = +document.getElementById("steps-input").value; // Steps in simulation.
    var mass = +document.getElementById("mass-input").value; // Mass in kg.
    var springConstant = +document.getElementById("spring-input").value; // Spring constant in N/m.
    var dampingConstant = +document.getElementById("damping-input").value; // Damping constant in N m/s.
    var startPosition = +document.getElementById("startPos-input").value; // Starting displacement of spring in m.
    var timeStep = duration / steps; // Size in seconds of time step.
    var time = [];
    for (var i = 0; i != steps + 1; ++i) time[i] = i * timeStep // Loop to fill time vector with timesteps to be used in graphing. Numbers will not be precise at 14 decimal places, but doesn't matter.

    // console.log('time: ', time);
    // console.log('time step: ', timeStep);

    // Initialize arrays to fill.
    var positionVV = [];
    var velocityVV = [];
    var accelerationVV = [];

    // Starting conditions: first time step.
    positionVV[0] = startPosition; // Set the first value in the position array to the starting position defined earlier.
    accelerationVV[0] = (-springConstant * startPosition) / mass;
    velocityVV[0] = 0;

    // Simulation loop: time step 2 onward
    for (var i = 1; i != steps + 1; ++i) { // Loop from step 2 to the number of steps in the simulation
      //Velocity verlet method for calculating velocity and position from acceleration.

      //Velocity verlet method for calculating velocity and position from acceleration.

      accelerationVV[i] = (-springConstant * positionVV[i - 1] + dampingConstant * velocityVV[i - 1]) / mass; // a=F/m, with F calculated as the sum of the spring and damping forces from the previous time step.
      velocityVV[i] = velocityVV[i - 1] + (accelerationVV[i] + accelerationVV[i - 1]) / 2 * timeStep; // Velocity verlet method, in which vel is the previous velocity + the average acceleration from this and the previous time step times the time step.
      positionVV[i] = positionVV[i - 1] + velocityVV[i] * timeStep + 0.5 * accelerationVV[i] * timeStep ^ 2; // Velocity verlet method, in which position is calculated from the previous position, current velocity and current acceleration.


    } // End of simulation loop. 


    console.log('Pos=', positionVV.slice(0, 5));
    console.log('Vel=', velocityVV.slice(0, 5));
    console.log('Accel=', accelerationVV.slice(0, 5));



    // Create data arrays for graph, using transpose fn.
    var timeVel = transpose([time, velocityVV]);
    var timeAccel = transpose([time, accelerationVV]);
    var data = new google.visualization.DataTable();

    data.addColumn('number', 'Time');
    data.addColumn('number', 'Velocity (m/s)');

    data.addRows(timeVel);

    var data2 = new google.visualization.DataTable();
    data2.addColumn('number', 'Time');
    data2.addColumn('number', 'Acceleration (m/s/s)');
    data2.addRows(timeAccel);

    var options = { // Display options, such as line thickness, color.
      //      animation: {
      //        startup: true,
      //        duration: 400,
      //      },
      tooltip: {
        trigger: 'selection'
      },
      legend: 'none',
      lineWidth: 1,
      chartArea: {
        left: 70,
        top: 6,
        width: '80%',
        height: '80%'
      },
      fontSize: 16,
      hAxis: {
        title: 'Time (s)',
      },
      vAxis: {
        title: 'Velocity (m/s)',
      },
      colors: ['#0a56ce']
    }

    // Instantiate the chart.
    var chart1 = new google.visualization.LineChart(document.getElementById('velocity_chart'));

    var chart2 = new google.visualization.LineChart(document.getElementById('accel_chart'));

    // Call the draw function on the charts.
    chart1.draw(data, options);

    options.vAxis.title = 'Acceleration (m/s/s)'; // Replace the vAxis label in the options for any subsequent graphs created.
    options.colors = ['#c70000'];

    chart2.draw(data2, options);

  } // End of springMass function.

  // Transpose 2D Array
  function transpose(original) { // Transpose 2D Array
    var copy = [];
    for (var i = 0; i < original.length; ++i) {
      for (var j = 0; j < original[i].length; ++j) {
        // skip undefined values to preserve sparse array
        if (original[i][j] === undefined) continue;
        // create row if it doesn't exist yet
        if (copy[j] === undefined) copy[j] = [];
        // swap the x and y coords for the copy
        copy[j][i] = original[i][j];
      }
    }
    return copy;
  } // End of transpose function.

  // TODO: Example format for To Do.

</script>

<body>

  <h4 style="font-family:arial;margin: 1%">Velocity (m/s)</h4>
  <div id="velocity_chart" style="width: 600px; height: 250px"></div>
  <h4 style="font-family:arial;margin: 1%">Acceleration (m/s/s)</h4>
  <div id="accel_chart" style="width: 600px; height: 250px"></div>
  <br>
  <p style="font-family:arial;margin: 1%">Duration (s):
    <input type="number" id="duration-input" value="100">

    <p style="font-family:arial;margin: 1%">Steps:
      <input type="number" id="steps-input" value="1000">

      <p style="font-family:arial;margin: 1% ">Mass (kg):
        <input type="number" id="mass-input" value="10">

        <p style="font-family:arial;margin: 1% ">Spring Constant (N/m):
          <input type="number" id="spring-input" value="10">

          <p style="font-family:arial;margin: 1% ">Damping coefficient (N s/m):
            <input type="number" id="damping-input" value="1">

            <p style="font-family:arial;margin: 1% ">Starting position (m):
              <input type="number" id="startPos-input" value="1">
              <br><br>
              <button id="runSim" style="width: 200px; height: 45px; margin: 1%; font-size: 18px; background-color: #f5f5f5;" onclick="springMass()">Apply</button>


              <button style="width: 200px; height: 45px; margin: 1%; font-size: 18px; background-color: #f5f5f5;" onclick="location.reload()">Reload</button>

</body>

</html>
